# CompanyAI - √Ñnderungshistorie

Alle wichtigen √Ñnderungen an diesem Projekt werden in dieser Datei dokumentiert.

Das Format basiert auf [Keep a Changelog](https://keepachangelog.com/de/1.0.0/),
und dieses Projekt folgt [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unver√∂ffentlicht]

### Hinzugef√ºgt
- **üèóÔ∏è Hierarchical Permissions System (v2.1.0 - NEU)**:
  - **Automatische Abteilungs-Hierarchie-Erkennung**: Analysiert vorhandene User-Daten und erkennt Strukturen automatisch
    - Parsing von Abteilungsfeldern mit " | " Separator (z.B. "Verkauf | AS", "HR | Recruiting")
    - Obergruppen (Abteilungen) und Untergruppen automatisch erkannt
    - **3-Stufen-Dropdown-Selektor**: Abteilung ‚Üí Untergruppe ‚Üí Benutzer Navigation
  - **Granulare Module-/Seiten-basierte Rechtevergabe**:
    - Modul-Level-Permissions (`hr`, `support`, `ai`, `admin-portal`) mit `none`, `read`, `write`, `admin` Levels
    - Seiten-Level-Permissions f√ºr alle Pages innerhalb Module (z.B. `hr.employees`, `support.tickets`)
    - Action-Level-Permissions (view, create, edit, delete, export, import, etc.)
    - Optional: Feature-Limits (dailyQuota, maxTokens, etc.)
  - **Rechtevererbung-System**: Untergruppen erben Basis-Rechte von Obergruppe + k√∂nnen erweitert werden
  - **Individual-User-Overrides**: Spezifische Abweichungen f√ºr einzelne Benutzer m√∂glich
  - **üéõÔ∏è Permission-Matrix-Editor**: Visuelle Bearbeitung von Modul- und Seiten-Berechtigungen
  - **Live-Vorschau**: Effektive Berechtigungen werden in Echtzeit berechnet und angezeigt
  - **Backend-APIs (6 neue Endpunkte)**:
    - `GET /api/admin-portal/hierarchy/analyze` - User-Hierarchie analysieren
    - `GET /api/admin-portal/hierarchy/structure` - Gespeicherte Hierarchie laden  
    - `GET/PUT /api/admin-portal/hierarchy/departments/:id/permissions` - Department-Permissions verwalten
    - `GET /api/admin-portal/hierarchy/users/:id/effective-permissions` - Effektive User-Permissions berechnen
    - `GET /api/admin-portal/hierarchy/modules` - Module-Definitionen f√ºr Permission-Matrix
  - **Frontend-Integration**:
    - **HierarchyPage.tsx**: Haupt-Interface mit 3 Tabs (Struktur-Analyse, Permission-Matrix, User-√úbersicht)
    - **Permission-Matrix-UI**: Modul/Page-Grid mit Action-Checkboxes und Limits-Konfiguration
    - **Hierarchie-Navigation**: Admin-Portal ‚Üí Rechte ‚Üí "Hierarchische Rechte" (neue Primary-Route)
    - **CSS-Styles**: 500+ Zeilen neue Styles f√ºr komplexe Permission-UI
- **Admin-Portal Major Update (v2.0.0)**: Untermodul-Architektur + Permission-System
  - **üèóÔ∏è Vollst√§ndige Umstrukturierung** in 3 logische Untermodule
  - **üìÅ Neue Frontend-Architektur** mit `submodules/` f√ºr bessere Skalierbarkeit
  - **üîê Permission-System (KOMPLETT NEU)**:
    - Rollen-Management mit granularen Berechtigungen
    - Gruppen-Verwaltung mit Rollen-Zuweisung  
    - API-Token-Management f√ºr externe Integrationen
    - Audit-Logs mit erweiterten Filteroptionen
  - **üì± Hierarchische Navigation** mit mehrstufigen Submenus
  - **20 neue API-Endpunkte** f√ºr Permission-Management (68+ gesamt)
  - **4 neue Frontend-Pages** f√ºr Rechte-Verwaltung
  - **üéØ URL-Umstrukturierung** f√ºr logische Gruppierung:
    - System: `/admin-portal/system/dashboard`, `/admin-portal/system/stats`
    - Benutzer: `/admin-portal/users/overview`, `/admin-portal/users/sync`, etc.
    - Rechte: `/admin-portal/permissions/roles`, `/admin-portal/permissions/groups`, etc.
- **‚≠ê Entra Admin Center Integration (v2.3.1)**: Direkte Integration zwischen Admin Portal und HR DataSources
  - **DataSources Graph API Client**: Admin Portal nutzt jetzt die gleiche Graph API Logic wie HR Modul
  - **Fetch und Store**: Neue Funktion l√§dt User direkt aus Entra Admin Center und speichert in Admin Portal DB
  - **API-Endpunkte**: `POST /api/admin-portal/entra/fetch-from-admin-center`, `GET /api/admin-portal/entra/check-availability`
  - **Shared Dependencies**: Wiederverwendung von `getAppToken()`, `graphGet()`, `graphGetAllPages()`, `testConnection()`
  - **PowerShell Test-Script**: `tools/test-entra-admin-center.ps1` f√ºr vollst√§ndige Integration-Tests
- **Externe RAG Speicherung**: RAG System unterst√ºtzt jetzt externe Ordner f√ºr Dokumentenspeicherung
  - Neue ENV-Variable: `RAG_EXTERNAL_DOCS_PATH` f√ºr externen Dokumentenordner
  - Erweiterte ENV-Variable: `RAG_INDEX_PATH` f√ºr externe Index-Datei
  - Automatische Erstellung externer Ordner falls nicht vorhanden
  - Frontend zeigt externe/interne Speicherung in DocsPage an
  - Bessere Trennung zwischen Projekt-Code und RAG-Daten

### Ge√§ndert  
- **üîê .cursorrules-Erwiterung (Hierarchical Permissions)**: Kritische neue Regeln f√ºr Module-Integration
  - **Modul-Permission-Definition-Pflicht**: Jedes neue Modul MUSS Hierarchical Permission-System integrieren
  - **Backend-Integration-Checkliste**: Permission-Checks in orchestrator.ts, Module-Definitionen in hierarchyAnalyzer.ts
  - **Frontend-Integration-Checkliste**: useUserPermissions Hook, Permission-Guards, Feature-Guards, Error-States
  - **Dokumentations-Updates**: Permission-Sektionen in README.md/API.md, INTERDEPENDENCY.md Permission-Dependencies
  - **Nicht-Erlaubt-Liste**: Hard-Fails f√ºr Module ohne Permission-Integration, umgehen des Systems
  - **Migration-Regeln**: Bestehende Module m√ºssen schrittweise migriert werden
- **Backend-Integration**: Haupt-App (`app.ts`) um Admin-Portal-Routen erweitert
- **Frontend-Navigation**: Sidebar um Admin-Portal mit 7 Untermen√º-Punkten erweitert + "Hierarchische Rechte" Primary-Route
- **Dashboard**: Modul-√úbersicht um Admin-Portal-Kachel mit 48 API-Endpunkten erweitert
- **Auth-System**: Admin-Permissions um neue Ressourcen erweitert (`admin_users`, `system_settings`, etc.)
- **Package-Dependencies**: Backend um SQLite, LDAP, CSV-Parser-Bibliotheken erweitert
- **AI Module**: Dokumentation komplett √ºberarbeitet f√ºr Multi-Provider + externe Speicherung
- **INTERDEPENDENCY.md**: Erweitert um Admin-Portal Dependencies und externe Speicher-Dependencies
- **DOCUMENTATION_OVERVIEW.md**: Erweitert um Admin-Portal-Modul-Dokumentation
- **Backend .env**: Neue Datei mit vollst√§ndiger Konfiguration hinzugef√ºgt

### Geplant
- Datenbank-Integration (PostgreSQL/MongoDB)
- Automatisierte Tests (Jest/Supertest)
- Produktion-Modul Implementation
- Erweiterte Sicherheitsfeatures (Rate Limiting, Input Sanitization)

### üß© Docs/Integrations
- HR ‚Üî DataSources Abh√§ngigkeit dokumentiert (lesen: combined, schreiben: manual)
- Admin-Portal ‚Üî Externe Datenbanken vollst√§ndig dokumentiert
  - 4 separate SQLite-Datenbanken mit Source-of-Truth-per-Database
  - Microsoft Entra ID Graph API Integration
  - LDAP-Server Integration (Active Directory, OpenLDAP)
  - CSV/Excel-Upload-Processing mit Auto-Schema-Migration
  - Manual-Web-User-CRUD mit Custom-Fields-Support
  - E-Mail-Conflict-Detection zwischen allen Quellen
- HR‚ÄëREADME und HR‚ÄëAPI um DataSources‚ÄëDetails erg√§nzt
- INTERDEPENDENCY.md erweitert (Global Rules + HR‚ÄëBindings)
- DOCUMENTATION_OVERVIEW.md entsprechend aktualisiert
 - Architektur: `docs/architecture/entra-id-user-schema.md` hinzugef√ºgt (Entra ID Benutzer-Schema Diagramm) und verlinkt

### ü§ñ AI / RAG
- AI‚ÄëModul (Direkt‚ÄëProvider Chat + RAG) dokumentiert:
  - `docs/modules/ai/API.md` um Endpunkte `/api/ai/chat`, `/api/ai/hr-assist`, `/api/ai/rag/*` erweitert
  - `docs/INTERDEPENDENCY.md` um AI/RAG Dependencies (ENV, Storage, Frontend-Bindings) erg√§nzt
  - `docs/DOCUMENTATION_OVERVIEW.md` um AI‚ÄëModul‚ÄëSektion + ENV‚ÄëBeispiele erweitert

## [2.1.0] - 2024-12-08

### üîß Verbesserungen - Grundkonstrukt-Optimierung
- **Auth-Guard hinzugef√ºgt**: RequireAuth-Komponente sch√ºtzt alle gesch√ºtzten Routen
- **Support-Module Security**: requirePermission Middleware f√ºr alle Support-Endpunkte
- **Dynamic Header**: User-Info wird dynamisch aus localStorage geladen
- **Ticket-Validierung**: Vollst√§ndige Input-Validierung f√ºr Support-Tickets
- **Error-Standardisierung**: Einheitliche englische Error-Typen + deutsche Messages
- **Monorepo-Setup**: npm workspaces f√ºr besseres Dependency-Management
- **Zentrales Error-Handling**: 404 und 500 Handler im Backend
- **Port-Standardisierung**: Vite auf Standard-Port 5173
- **Router-Cleanup**: Veraltete @types/react-router-dom entfernt

### üß© DataSources & Integrations
- EntraAC DataSource (Microsoft Entra ID) implementiert: Client Credentials (MSAL), Sync (Users/Devices), Combined-Logic
- Manual DataSource implementiert: CRUD f√ºr Benutzer/Ger√§te (separat von Entra)
- Zentrale DataSources API unter `/api/data/*` (users, devices, sources, stats, sync, sync/status)
- `.env` erweitert: `AZURE_TENANT_ID`, `AZURE_CLIENT_ID`, `AZURE_CLIENT_SECRET`, `GRAPH_BASE_URL`, `ENTRA_SYNC_ENABLED`, `ENTRA_SYNC_INTERVAL_MS`
- Dokumentation aktualisiert: `INTERDEPENDENCY.md` (DataSources-Dependencies), `DOCUMENTATION_OVERVIEW.md` (Integration-Architektur)

### üìè Regeln/Prozess
- `.cursorrules`: PR/Review-Gates f√ºr DataSources/Integrations (KRITISCH) erg√§nzt
 - `.cursorrules`: PR/Review-Gates f√ºr Frontend Theme & Layout-Konfiguration erg√§nzt (ENV/Docs Pflicht-Updates)

### üé® Frontend Theme/Branding
- Neues Theme-System: `ThemeProvider` (React Context), CSS Custom Properties
- Frontend `.env` Variablen (`VITE_*`) f√ºr Branding/Colors/Layout
- `Header.tsx`, `Header.css`, `Sidebar.css`, `index.css` um Variablen erweitert
- Optionale `ThemeSettings` UI zur Laufzeit-Anpassung

### üõ°Ô∏è Sicherheit
- Alle Support-Endpunkte nun mit Berechtigungspr√ºfung
- Auth-Guard verhindert unbefugten Zugriff auf gesch√ºtzte Bereiche
- Strukturierte Error-Responses ohne sensitive Details
- Vollst√§ndige Request-Validierung f√ºr Support-Tickets

### üöÄ Developer Experience
- npm workspaces Setup f√ºr einfachere Entwicklung
- Einheitliche Error-Typen f√ºr bessere API-Konsistenz
- Zentrales Error-Handling f√ºr robustere Anwendung
- Port-Konsistenz zwischen Konfiguration und Tests

## [2.0.0] - 2024-12-08

### üéâ Hinzugef√ºgt - Modulare Architektur Komplett-Rewrite
- **Modulbasierte Architektur** vollst√§ndig implementiert
- **HR-Modul** mit 6 Hauptfunktionen:
  - Mitarbeiterdatenverwaltung (CRUD Operations)
  - Onboarding-Plan-Generierung mit abteilungsspezifischen Templates
  - HR-Reporting mit detaillierten Statistiken und Analysen
  - Mitarbeiterstatistiken und Metriken
  - Rollenbasierte Zugriffskontrolle
- **Support-Modul** f√ºr Ticket-Management:
  - Ticket-Erstellung mit Kategorisierung
  - Ticket-Suche und Filterung
  - Status-Management und Priorisierung
- **Zentrale Authentifizierung**:
  - Rollenbasiertes Berechtigungssystem
  - Mock-Token-System f√ºr Entwicklung
  - Logging f√ºr alle Authentifizierungs-Events
- **API-Infrastruktur**:
  - 11 REST-API-Endpunkte implementiert
  - Konsistente APIResponse<T> Struktur
  - Paginierung f√ºr Listen-Endpunkte
  - Umfassende Error-Handling
- **Entwickler-Tools**:
  - PowerShell-Test-Script f√ºr alle Module
  - Modulare Route-Registrierung
  - Automatische API-Dokumentation
  - .cursorrules f√ºr konsistente Entwicklung

### üèóÔ∏è Ver√§ndert
- **Backend-Architektur** komplett √ºberarbeitet von monolithisch zu modular
- **API-Struktur** von einfachen Routes zu modulbasierten Endpunkten
- **Authentifizierung** von keiner zu vollst√§ndiger rollenbasierter Auth
- **TypeScript-Struktur** mit strikten Types und Interfaces pro Modul

### üìÅ Dateistruktur - NEU
```
backend/src/modules/
‚îú‚îÄ‚îÄ hr/
‚îÇ   ‚îú‚îÄ‚îÄ orchestrator.ts         # Route-Handler & Koordination
‚îÇ   ‚îú‚îÄ‚îÄ types.ts               # TypeScript-Interfaces
‚îÇ   ‚îú‚îÄ‚îÄ core/auth.ts           # Authentifizierung & Autorisierung  
‚îÇ   ‚îî‚îÄ‚îÄ functions/             # Gesch√§ftslogik-Funktionen
‚îÇ       ‚îú‚îÄ‚îÄ fetchEmployeeData.ts
‚îÇ       ‚îú‚îÄ‚îÄ generateOnboardingPlan.ts
‚îÇ       ‚îî‚îÄ‚îÄ createHRReport.ts
‚îú‚îÄ‚îÄ support/
‚îÇ   ‚îú‚îÄ‚îÄ orchestrator.ts
‚îÇ   ‚îú‚îÄ‚îÄ types.ts
‚îÇ   ‚îî‚îÄ‚îÄ functions/
‚îÇ       ‚îî‚îÄ‚îÄ manageTickets.ts
‚îî‚îÄ‚îÄ README.md                  # Modul-Dokumentation
```

### üîß Technische Details
- **Express.js** Router-basierte Modul-Registrierung
- **TypeScript** strict mode mit umfassenden Interface-Definitionen
- **Mock-Daten** f√ºr alle Module w√§hrend Entwicklung
- **PowerShell-Kompatibilit√§t** f√ºr alle Scripts und Commands
- **CORS** aktiviert f√ºr Frontend-Integration

### üìä Metriken (Stand 2.0.0)
- **Code-Zeilen:** ~1.500 (Backend)
- **TypeScript-Dateien:** 12
- **API-Endpunkte:** 11
- **Module:** 2 (HR vollst√§ndig, Support Basis)
- **Test-Coverage:** Manuelle PowerShell-Tests

## [1.0.0] - 2024-12-07

### üéâ Hinzugef√ºgt - Projekt-Initialisierung
- **Basis-Projekt-Setup** mit monolithischer Struktur
- **Backend** (Node.js + Express + TypeScript):
  - Einfacher Express-Server auf Port 5000
  - Grundlegende Health-Check und Hello-Endpunkte
  - TypeScript-Konfiguration
  - CORS-Middleware
- **Frontend** (React + Vite + TypeScript):
  - Basis React-App mit Vite-Build-System
  - TypeScript-Integration
  - Basis-Styling mit CSS
- **Development-Tools**:
  - tools/install-all.ps1 Script f√ºr PowerShell-Setup
  - Package.json Scripts f√ºr Development
  - Git-Repository Initialisierung

### üìÅ Initiale Dateistruktur
```
CompanyAI/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îî‚îÄ‚îÄ src/index.ts           # Einfacher Express-Server
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îú‚îÄ‚îÄ index.html
‚îÇ   ‚îú‚îÄ‚îÄ vite.config.ts
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ main.tsx
‚îÇ       ‚îú‚îÄ‚îÄ App.tsx
‚îÇ       ‚îî‚îÄ‚îÄ App.css
‚îú‚îÄ‚îÄ package.json               # Root-Package f√ºr Scripts
‚îú‚îÄ‚îÄ tools/install-all.ps1     # PowerShell Setup-Script
‚îî‚îÄ‚îÄ README.md                 # Basis-Dokumentation
```

### üîß Technische Basis
- **Node.js** >= 18.0.0
- **TypeScript** f√ºr Type-Safety
- **Vite** f√ºr schnelle Frontend-Entwicklung
- **PowerShell** Scripts f√ºr Windows-Kompatibilit√§t

### üìä Initiale Metriken
- **Code-Zeilen:** ~200 (gesamt)
- **Dependencies:** Express, React, TypeScript, Vite
- **API-Endpunkte:** 3 (health, hello, root)

---

## Legende der √Ñnderungstypen

### üéâ Hinzugef√ºgt
Neue Features und Funktionalit√§ten

### üèóÔ∏è Ver√§ndert  
√Ñnderungen an bestehender Funktionalit√§t

### üêõ Behoben
Bug-Fixes und Fehlerbehebungen

### ‚ùå Entfernt
Entfernte Features oder Dateien

### üîí Sicherheit
Sicherheitsrelevante √Ñnderungen

### üìÅ Dateistruktur
Strukturelle √Ñnderungen am Projekt

### üîß Technisch
Technische/interne √Ñnderungen ohne User-Impact

### üìä Metriken
Quantitative Projekt-Metriken

---

## Versions-Schema

CompanyAI folgt [Semantic Versioning](https://semver.org/):

- **MAJOR.MINOR.PATCH** (z.B. 2.1.3)
- **MAJOR:** Breaking Changes, Architektur-√Ñnderungen
- **MINOR:** Neue Features, Module, API-Erweiterungen  
- **PATCH:** Bug-Fixes, kleine Verbesserungen

### Release-Branches
- **main:** Stabile, produktionsbereite Releases
- **develop:** Integration Branch f√ºr neue Features
- **feature/*** Feature-spezifische Branches
- **hotfix/*** Kritische Bug-Fixes

---

**Letzte Aktualisierung:** 8. Dezember 2024  
**Dokumentations-Version:** 1.0.0
